# AGENTS.md

本文件是后续 AI/Agent 改动本仓库时的执行约定。

## 目标

- 维持“无 build、可直接打开运行”的项目形态。
- 维持“运营配置与引擎解耦”的边界。
- 优先小步快改，避免一次性大重写。

## 目录职责（必须遵守）

- `app/`: 仅页面与样式（入口 `app/index.html`）
- `config/`: 仅配置数据（运营可改）
- `src/`: 仅引擎逻辑（开发可改）
- `docs/`: 说明文档

不要把引擎逻辑写回 `config/` 或 `app/`，不要把配置硬编码回 `src/`。

## 修改优先级

1. 先改配置，再考虑改引擎。
2. 若需求能通过 `config/game-config.js` 完成，不动 `src/game-engine.js`。
3. 若必须改引擎，保持对现有配置向后兼容。

## 配置设计约束

- 配置使用声明式结构（condition/effects），不要在配置里引入函数。
- 新增字段时，先给默认值并做兜底，避免旧配置崩溃。
- 运营常改项必须有清晰注释或在 `docs/运营配置说明.md` 记录。

## 代码风格

- 使用原生 ES 语法，避免引入打包器依赖。
- 命名清晰、单一职责，避免巨大函数持续膨胀。
- 仅在必要处加注释，注释解释“为什么”，不复述“做了什么”。
- 若出现大段重复逻辑（例如多个流程共享同一结算/渲染步骤），优先抽取复用函数，避免复制粘贴分叉。

## DOM 与页面契约（必须遵守）

- `src/game-engine.js` 使用的 `id`，必须在 `app/index.html` 中存在；如果是可选 UI，必须做空值兜底（`if (el) { ... }`）。
- 修改 `app/index.html` 结构后，必须检查对应引擎逻辑是否仍能找到目标节点。
- 不允许依赖“测试桩自动创建缺失 DOM 节点”的行为来掩盖问题。

## 条件表达式安全约束

- 配置中的条件表达式仅允许受限算术能力（数字、`realmIdx`、`+ - * /`、括号）。
- 禁止在引擎中使用 `eval`/`Function` 执行配置字符串。
- 表达式解析失败时必须安全降级（不抛异常、不中断主流程）。

## 验证要求

每次改动后至少执行：

1. `bash scripts/check.sh` - 运行完整检查（ESLint、JSON验证、冒烟测试、单元测试）
2. 手动验证 `app/index.html` 可打开，核心流程可跑通（开局 -> 修炼 -> 结算）
3. 若修复过 bug，必须新增或更新对应回归测试，确保同类问题下次能被测试直接拦截。

## 测试约束

- `scripts/game-test-harness.js` 应尽量贴近真实 DOM 行为：未知 id 返回 `null`，不要静默伪造节点。
- 新增引擎逻辑时，优先补 `tests/engine-behavior.test.js` 中的行为级测试（流程可跑通、关键状态变化正确）。
- 涉及 UI 节点读取的逻辑，至少覆盖一个“节点缺失时不崩溃”的测试用例（若该节点是可选）。
- 配置相关校验优先放 `tests/config-contract.test.js`，仅校验契约（结构/类型/安全），不要把运营数值写死在断言里。
- 只有“明确应长期稳定”的常量才放 `tests/pinned-values.test.js`，避免把可调参数误归入固定值测试。

**注意**：每次大批量修改后必须运行 `scripts/check.sh`，确保代码质量和测试通过。

## 禁止事项

- 不要引入 build 流程（webpack/vite 等）作为默认运行方式。
- 不要把版本号塞进页面文件名（保持 `app/index.html`）。
- 不要在未说明的情况下重置或删除用户配置内容。
